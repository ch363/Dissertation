generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum KNOWLEDGE_LEVEL {
  A1
  A2
  B1
  B2
  C1
  C2
}

enum DELIVERY_METHOD {
  FILL_BLANK
  FLASHCARD
  MULTIPLE_CHOICE
  SPEECH_TO_TEXT
  TEXT_TO_SPEECH
  TEXT_TRANSLATION
}

model Module {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String   @db.VarChar
  description String?  @db.VarChar
  imageUrl    String?  @map("image_url") @db.VarChar
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  lessons Lesson[]

  @@map("modules")
}

model Lesson {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String   @db.VarChar
  description   String?  @db.VarChar
  imageUrl      String?  @map("image_url") @db.VarChar
  numberOfItems Int      @default(0) @map("number_of_items")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  moduleId String @map("module_id") @db.Uuid
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  teachings   Teaching[]
  userLessons UserLesson[]

  @@map("lessons")
}

model Teaching {
  id                     String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  knowledgeLevel         KNOWLEDGE_LEVEL @map("knowledge_level")
  emoji                  String?         @db.VarChar
  userLanguageString     String          @map("user_language_string") @db.VarChar
  learningLanguageString String          @map("learning_language_string") @db.VarChar
  tip                    String?         @db.VarChar
  createdAt              DateTime        @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt              DateTime        @updatedAt @map("updated_at") @db.Timestamp(6)

  lessonId String @map("lesson_id") @db.Uuid
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  questions              Question[]
  userTeachingsCompleted UserTeachingCompleted[]
  skillTags              SkillTag[]

  @@map("teachings")
}

model Question {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  teachingId String   @map("teaching_id") @db.Uuid
  teaching   Teaching @relation(fields: [teachingId], references: [id], onDelete: Cascade)

  type DELIVERY_METHOD @map("type")

  // One-to-One Relations
  fillBlank       QuestionFillBlank?
  multipleChoice  QuestionMultipleChoice?
  speechToText    QuestionSpeechToText?
  textTranslation QuestionTextTranslation?
  flashcard       QuestionFlashcard?
  textToSpeech    QuestionTextToSpeech?

  userQuestionPerformance UserQuestionPerformance[]
  skillTags               SkillTag[]

  @@index([teachingId])
  @@index([type])
  @@map("questions")
}

model QuestionFillBlank {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // Which tokens are blanked in Teaching.learningLanguageString
  blankIndices Int[] @map("blank_indices")

  // Per-blank accepted answers. Example: {"0":["sono"],"2":["andato","andata"]}
  acceptedAnswers Json @map("accepted_answers")

  questionId String   @unique @map("question_id") @db.Uuid
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_fill_blanks")
}

model QuestionMultipleChoice {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  options        String[]
  correctIndices Int[]    @map("correct_indices")

  questionId String   @unique @map("question_id") @db.Uuid
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_multiple_choice")
}

model QuestionSpeechToText {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  acceptedAnswers String[] @map("accepted_answers")

  questionId String   @unique @map("question_id") @db.Uuid
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_speech_to_text")
}

model QuestionTextTranslation {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  acceptedAnswers String[] @map("accepted_answers")

  questionId String   @unique @map("question_id") @db.Uuid
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_text_translation")
}

model QuestionFlashcard {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  questionId String   @unique @map("question_id") @db.Uuid
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_flashcards")
}

model QuestionTextToSpeech {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  questionId String   @unique @map("question_id") @db.Uuid
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_text_to_speech")
}

model User {
  id                      String           @id @db.Uuid
  name                    String?          @db.VarChar
  avatarUrl               String?          @map("avatar_url") @db.VarChar
  knowledgePoints         Int              @default(0) @map("knowledge_points")
  knowledgeLevel          KNOWLEDGE_LEVEL  @default(A1) @map("knowledge_level")
  preferredDeliveryMethod DELIVERY_METHOD? @map("preferred_delivery_method")
  createdAt               DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt               DateTime         @updatedAt @map("updated_at") @db.Timestamp(6)

  userDeliveryMethodScores   UserDeliveryMethodScore[]
  userKnowledgeLevelProgress UserKnowledgeLevelProgress[]
  userLessons                UserLesson[]
  userTeachingsCompleted     UserTeachingCompleted[]
  userQuestionPerformance    UserQuestionPerformance[]
  userSkillMastery           UserSkillMastery[]
  xpEvents                   XpEvent[]
  onboardingAnswer           OnboardingAnswer?

  @@map("users")
}

model UserDeliveryMethodScore {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String          @map("user_id") @db.Uuid
  deliveryMethod DELIVERY_METHOD @map("delivery_method")
  score          Float           @default(0)
  updatedAt      DateTime        @updatedAt @map("updated_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, deliveryMethod])
  @@index([userId])
  @@index([deliveryMethod])
  @@map("user_delivery_method_scores")
}

model UserKnowledgeLevelProgress {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  value     Int
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  userId    String   @map("user_id") @db.Uuid

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@map("user_knowledge_level_progress")
}

model UserLesson {
  userId             String   @map("user_id") @db.Uuid
  lessonId           String   @map("lesson_id") @db.Uuid
  completedTeachings Int      @default(0) @map("completed_teachings")
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@id([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("user_lessons")
}

model UserTeachingCompleted {
  userId     String   @map("user_id") @db.Uuid
  teachingId String   @map("teaching_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  teaching Teaching @relation(fields: [teachingId], references: [id], onDelete: Cascade)

  @@id([userId, teachingId])
  @@index([userId])
  @@index([teachingId])
  @@map("user_teachings_completed")
}

model UserQuestionPerformance {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String    @map("user_id") @db.Uuid
  questionId         String    @map("question_id") @db.Uuid
  score              Int
  timeToComplete     Int?      @map("time_to_complete")
  percentageAccuracy Int?      @map("percentage_accuracy")
  attempts           Int?
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  lastRevisedAt      DateTime? @map("last_revised_at") @db.Timestamp(6)
  nextReviewDue      DateTime? @map("next_review_due") @db.Timestamp(6)
  intervalDays       Int?      @map("interval_days")
  easeFactor         Float?    @map("ease_factor")
  stability          Float?    @map("stability")
  difficulty         Float?    @map("difficulty")
  repetitions        Int?      @default(0)

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([questionId])
  @@index([userId, questionId])
  @@index([nextReviewDue])
  @@map("user_question_performance")
}

model XpEvent {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  amount     Int
  reason     String   @db.VarChar
  occurredAt DateTime @default(now()) @map("occurred_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, occurredAt])
  @@map("xp_events")
}

model OnboardingAnswer {
  userId    String   @id @map("user_id") @db.Uuid
  answers   Json
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_answers")
}

model SkillTag {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique @db.VarChar
  description String?  @db.VarChar
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  teachings Teaching[]
  questions Question[]

  @@map("skill_tags")
}

model UserSkillMastery {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String   @map("user_id") @db.Uuid
  skillTag           String   @map("skill_tag") @db.VarChar
  masteryProbability Float    @map("mastery_probability")
  prior              Float    @default(0.3)
  learn              Float    @default(0.2)
  guess              Float    @default(0.2)
  slip               Float    @default(0.1)
  lastUpdated        DateTime @updatedAt @map("last_updated") @db.Timestamp(6)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillTag])
  @@index([userId])
  @@index([skillTag])
  @@index([userId, masteryProbability])
  @@map("user_skill_mastery")
}
